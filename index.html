<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- we import arjs version without NFT but with marker + location based support -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      .photo-button {
        width: 100px;
        height: 100px;
        top: 80%;
        left: 50%;
        margin-top: -50px;
        margin-left: -50px;
        position: absolute;
        z-index: 100;
      }
      .circle {
        position: absolute;
        top: 12%;
        left: 12%;
        bottom: 12%;
        right: 12%;
        border-radius: 100%;
        background-color: #ffffff;
        opacity: 0.8;
      }
      .ring {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;

        border-radius: 100%;
        border: 0.5em solid #ffffff;
        opacity: 0.8;
      }
    </style>
  </head>
  <body style="margin: 0px; overflow: hidden">
    <a-scene
      embedded
      arjs=" debugUIEnabled: false;detectionMode: mono_and_matrix; matrixCodeType: 3x3;sourceType: webcam;"
      vr-mode-ui="enabled: false"
    >
      <a-marker type="barcode" value="7">
        <a-entity
          rotation="0 270 0"
          scale="30 30 30"
          gltf-model="./logo.glb"
          animation="property: rotation; to: 0 270 360; loop: true; dur: 10000; easing:linear"
        ></a-entity>
        <!-- <a-box position="0 0 0" color="#4CC3D9"></a-box> -->
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    <div class="photo-button">
      <div onclick="takeScreenshot()" class="circle"></div>
      <div onclick="takeScreenshot()" class="ring"></div>
    </div>
  </body>
  <script src="https://unpkg.com/merge-images"></script>
  <script>
    function resizeCanvas(origCanvas, width, height) {
      let resizedCanvas = document.createElement("canvas");
      let resizedContext = resizedCanvas.getContext("2d");

      if (screen.width < screen.height) {
        var w = height * (height / width);
        var h = width * (height / width);
        var offsetX = -(height - width);
      } else {
        var w = width;
        var h = height;
        var offsetX = 0;
      }
      resizedCanvas.height = height;
      resizedCanvas.width = width;

      resizedContext.drawImage(origCanvas, offsetX, 0, w, h);
      return resizedCanvas.toDataURL();
    }
    function captureVideoFrame(video, format, width, height) {
      if (typeof video === "string") {
        video = document.querySelector(video);
      }

      format = format || "jpeg";

      if (!video || (format !== "png" && format !== "jpeg")) {
        return false;
      }

      var canvas = document.createElement("CANVAS");

      canvas.width = width || video.videoWidth;
      canvas.height = height || video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      var dataUri = canvas.toDataURL("image/" + format);
      var data = dataUri.split(",")[1];
      var mimeType = dataUri.split(";")[0].slice(5);

      var bytes = window.atob(data);
      var buf = new ArrayBuffer(bytes.length);
      var arr = new Uint8Array(buf);

      for (var i = 0; i < bytes.length; i++) {
        arr[i] = bytes.charCodeAt(i);
      }

      var blob = new Blob([arr], { type: mimeType });
      return {
        blob: blob,
        dataUri: dataUri,
        format: format,
        width: canvas.width,
        height: canvas.height,
      };
    }
    function takeScreenshot() {
      let aScene = document
        .querySelector("a-scene")
        .components.screenshot.getCanvas("perspective");
      let frame = captureVideoFrame("video", "png");
      aScene = resizeCanvas(aScene, frame.width, frame.height);
      frame = frame.dataUri;
      mergeImages([frame, aScene]).then((b64) => {
        // Create a link element
        let link = document.createElement("a");
        link.setAttribute("download", "AR.png");
        link.setAttribute("href", b64);
        link.click();
      });
    }
  </script>
</html>
